name: Azure Static Web Apps CI/CD

on:
  push:
    branches: ["main"]
    paths:
      - "apps/web/**"
      - "packages/**"
      - "package.json"
      - "package-lock.json"
      - ".github/workflows/frontend.yml"
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches: ["main"]
    paths:
      - "apps/web/**"
      - "packages/**"
      - "package.json"
      - "package-lock.json"
      - ".github/workflows/frontend.yml"
  workflow_dispatch:

env:
  STATIC_WEB_APP_NAME: land-parcel-automater
  RESOURCE_GROUP: LiDAR-Breakline-Generator

jobs:
  build_and_deploy_job:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    name: Build and Deploy Job
    permissions:
      id-token: write
      contents: read
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          lfs: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Sync Assets
        run: npm run assets:sync

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Debug deployment token
        run: |
          echo "Checking which token secret is available..."
          
          # Check AZURE_STATIC_WEB_APPS_API_TOKEN_BLUE_COAST_0E1B4690F
          if [ -n "${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_BLUE_COAST_0E1B4690F }}" ]; then
            echo "✓ AZURE_STATIC_WEB_APPS_API_TOKEN_BLUE_COAST_0E1B4690F is set"
            TOKEN="${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_BLUE_COAST_0E1B4690F }}"
            TOKEN_NAME="AZURE_STATIC_WEB_APPS_API_TOKEN_BLUE_COAST_0E1B4690F"
          elif [ -n "${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}" ]; then
            echo "✓ AZURE_STATIC_WEB_APPS_API_TOKEN is set"
            TOKEN="${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}"
            TOKEN_NAME="AZURE_STATIC_WEB_APPS_API_TOKEN"
          elif [ -n "${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_PROUD_FIELD_0FB18A70F }}" ]; then
            echo "✓ AZURE_STATIC_WEB_APPS_API_TOKEN_PROUD_FIELD_0FB18A70F is set"
            TOKEN="${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_PROUD_FIELD_0FB18A70F }}"
            TOKEN_NAME="AZURE_STATIC_WEB_APPS_API_TOKEN_PROUD_FIELD_0FB18A70F"
          else
            echo "ERROR: No deployment token secret found!"
            echo "Please set AZURE_STATIC_WEB_APPS_API_TOKEN_BLUE_COAST_0E1B4690F"
            exit 1
          fi
          
          echo "Using token: $TOKEN_NAME"
          TOKEN_LENGTH=${#TOKEN}
          echo "Token length: $TOKEN_LENGTH"
          
          # Check if token starts with expected format
          if [[ "$TOKEN" =~ ^[a-zA-Z0-9] ]]; then
            echo "Token format looks correct"
          else
            echo "WARNING: Token format might be incorrect"
          fi

      - name: Verify Static Web App details
        run: |
          echo "Static Web App details:"
          az staticwebapp show --name ${{ env.STATIC_WEB_APP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query "{name:name,defaultHostname:defaultHostname,repositoryUrl:repositoryUrl,branch:branch}" -o json
          
          echo ""
          echo "Checking repository configuration..."
          REPO_URL=$(az staticwebapp show --name ${{ env.STATIC_WEB_APP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query "repositoryUrl" -o tsv)
          REPO_BRANCH=$(az staticwebapp show --name ${{ env.STATIC_WEB_APP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query "branch" -o tsv)
          
          echo "Configured repository: $REPO_URL"
          echo "Configured branch: $REPO_BRANCH"
          echo "Current repository: ${{ github.repository }}"
          echo "Current branch: ${{ github.ref_name }}"
          
          # If there's ANY repository link, disconnect it to allow API token deployments
          if [ -n "$REPO_URL" ] && [ "$REPO_URL" != "None" ]; then
            echo ""
            echo "⚠️  Static Web App is linked to a GitHub repository."
            echo "This prevents API token deployments from working."
            echo "Disconnecting to enable API token deployments..."
            az staticwebapp disconnect --name ${{ env.STATIC_WEB_APP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }}
            echo "✓ Disconnected. The deployment should now work with API token."
          else
            echo "✓ No repository link found - API token deployments should work."
          fi
          
          echo ""
          echo "Getting deployment token from Azure to verify..."
          AZURE_TOKEN=$(az staticwebapp secrets list --name ${{ env.STATIC_WEB_APP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query "properties.apiKey" -o tsv)
          AZURE_TOKEN_LENGTH=${#AZURE_TOKEN}
          echo "Azure token length: $AZURE_TOKEN_LENGTH"
          
          # Compare with GitHub secret (without revealing the actual values)
          if [ -n "${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_BLUE_COAST_0E1B4690F }}" ]; then
            GITHUB_TOKEN="${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_BLUE_COAST_0E1B4690F }}"
            GITHUB_TOKEN_LENGTH=${#GITHUB_TOKEN}
            echo "GitHub secret (AZURE_STATIC_WEB_APPS_API_TOKEN_BLUE_COAST_0E1B4690F) length: $GITHUB_TOKEN_LENGTH"
            
            if [ "$AZURE_TOKEN" = "$GITHUB_TOKEN" ]; then
              echo "✓ Tokens match!"
            else
              echo "✗ Tokens DO NOT match - please update your GitHub secret"
              echo "First 10 chars of Azure token: ${AZURE_TOKEN:0:10}..."
              echo "First 10 chars of GitHub token: ${GITHUB_TOKEN:0:10}..."
            fi
          fi

      - name: Configure Static Web App Authentication
        run: |
          echo "Configuring authentication settings..."
          az staticwebapp appsettings set \
            --name ${{ env.STATIC_WEB_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --setting-names AZURE_CLIENT_ID=${{ secrets.AZURE_CLIENT_ID }}
          echo "Authentication configured successfully"

      - name: Build And Deploy
        env:
          PUBLIC_API_BASE_URL: ${{ vars.PUBLIC_API_BASE_URL }}
          PUBLIC_APP_BASE_PATH: ${{ vars.PUBLIC_APP_BASE_PATH }}
          PUBLIC_MAPTILER_API_KEY: ${{ vars.PUBLIC_MAPTILER_API_KEY }}
        id: builddeploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_BLUE_COAST_0E1B4690F }}
          action: "upload"
          ###### Repository/Build Configurations ######
          app_location: "apps/web" # App source code path
          api_location: "" # Api source code path - optional
          output_location: "dist" # Built app content directory - optional
          app_build_command: "npm run build" # Let Azure build it
          ###### End of Repository/Build Configurations ######

      - name: Purge Azure Front Door Cache
        if: success()
        run: |
          echo "Purging Front Door cache..."
          # Get Front Door profile and endpoint names
          FRONTDOOR_PROFILE=$(az afd profile list --resource-group ${{ env.RESOURCE_GROUP }} --query "[0].name" -o tsv)
          FRONTDOOR_ENDPOINT=$(az afd endpoint list --profile-name $FRONTDOOR_PROFILE --resource-group ${{ env.RESOURCE_GROUP }} --query "[0].name" -o tsv)
          
          if [ -n "$FRONTDOOR_PROFILE" ] && [ -n "$FRONTDOOR_ENDPOINT" ]; then
            echo "Purging cache for Front Door: $FRONTDOOR_PROFILE / $FRONTDOOR_ENDPOINT"
            az afd endpoint purge \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --profile-name $FRONTDOOR_PROFILE \
              --endpoint-name $FRONTDOOR_ENDPOINT \
              --content-paths "/*" \
              --domains "survey.hwcengineering.com"
            echo "Cache purge completed"
          else
            echo "Front Door not found or not configured, skipping cache purge"
          fi

  close_pull_request_job:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    name: Close Pull Request Job
    steps:
      - name: Close Pull Request
        id: closepullrequest
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_BLUE_COAST_0E1B4690F }}
          action: "close"
